!function(e){"use strict";function t(e,s){return new t.prototype.init(e,s)}Function.prototype.bind||(Function.prototype.bind=function(e){var t=this;return function(){return t.apply(e)}});e.fn.hdrupload=function(s){var r=[],o=Array.prototype.slice.call(arguments,1);return this.each("string"==typeof s?function(){var t,i=e.data(this,"hdrupload");if("-1"!=s.search(/\./)?(t=s.split("."),"undefined"!=typeof i[t[0]]&&(t=i[t[0]][t[1]])):t=i[s],"undefined"!=typeof i&&e.isFunction(t)){var n=t.apply(i,o);void 0!==n&&n!==i&&r.push(n)}else e.error('No such method "'+s+'" for hdrupload')}:function(){e.data(this,"hdrupload",{}),e.data(this,"hdrupload",t(this,s))}),0===r.length?this:1===r.length?r[0]:r},e.HDRUpload=t,e.HDRUpload.VERSION="0.0.1",e.HDRUpload.modules=["build","core","upload"],e.HDRUpload.opts={messageError:"",urlUploadFile:"",progressBar:"",thumbs:!1,classes:{dragOver:"",dragDrop:"",loaded:"",loading:""},success:function(){}},t.fn=e.HDRUpload.prototype={init:function(t,s){this.$element=e(t),this.uuid=Math.floor(1e6*Math.random()),this.inputName=this.$element.find("input[type=file]").attr("name"),this.inputId=this.$element.find("input[type=file]").attr("id"),this.loadOptions(s),this.loadModules(),this.start=!0,this.build.run()},loadOptions:function(t){this.opts=e.extend({},e.extend(!0,{},e.HDRUpload.opts),this.$element.data(),t)},getModuleMethods:function(e){return Object.getOwnPropertyNames(e).filter(function(t){return"function"==typeof e[t]})},loadModules:function(){for(var t=e.HDRUpload.modules.length,s=0;t>s;s++)this.bindModuleMethods(e.HDRUpload.modules[s])},bindModuleMethods:function(e){if("undefined"!=typeof this[e]){this[e]=this[e]();for(var t=this.getModuleMethods(this[e]),s=t.length,r=0;s>r;r++)this[e][t[r]]=this[e][t[r]].bind(this)}},build:function(){return{run:function(){this.filetype=this.opts.filetype,this.thumbs=this.opts.thumbs,this.$messageerror=this.build.messageError(),this.$progressbar=this.build.progressBar(),this.$messagedroparea=this.build.messageDropArea(),this.core.isDraggable()?this.build.drag(this,this.opts.classes):this.$messagedroparea.remove(),this.build.changeForm(this)},form:function(){this.$form=this.build.createForm(),this.$inputTypeFile=this.build.createInput(),this.$inputThumbs=this.build.createInputThumbs(),this.$element.find("input[type=file]").attr({name:"data[File][file]",id:"FileFile"}),this.kids=this.$element.children(),this.$form.append(this.$inputTypeFile),this.$form.append(this.$inputThumbs),this.$form.append(this.kids),this.$element.append(this.$form)},createForm:function(){return e("<form></form>").attr({id:"form-"+this.uuid,method:"post",action:this.core.action(),enctype:"multipart/form-data"})},destroyForm:function(){this.$inputTypeFile.remove(),this.$inputThumbs.remove(),this.$form.find("input[type=file]").attr({name:this.inputName,id:this.inputId}),this.kids=this.$form.children(),this.$element.append(this.kids),this.$form.remove()},messageError:function(){return e(this.opts.messageError).hide()},messageDropArea:function(){return e(this.opts.messageDropArea)},createInput:function(){return e("<input>").attr({type:"hidden",id:"fileType"+this.uuid,value:this.filetype,name:"data[File][fileType]"})},createInputThumbs:function(){return e("<input>").attr({type:"hidden",id:"thumbs"+this.uuid,value:this.thumbs,name:"data[File][thumbs]"})},progressBar:function(){return e(this.opts.progressBar)},changeForm:function(e){e.$element.on("change","input",function(){e.$element.parent().removeClass(e.opts.classes.loaded).addClass(e.opts.classes.loading),e.upload.jqueryForm(e)})},progressBarPercent:function(e){this.percentVal=e+"%",this.$progressbar.css("width",this.percentVal),this.$progressbar.attr("aria-valuenow",e),this.$progressbar.html(this.percentVal)},drag:function(e,t){e.$element.on("dragover",function(s){s.preventDefault(),s.stopPropagation(),e.$element.parent().addClass(t.dragOver)}),e.$element.on("dragenter",function(e){e.preventDefault(),e.stopPropagation()}),e.$element.on("dragleave",function(s){s.preventDefault(),s.stopPropagation(),e.$element.parent().removeClass(t.dragOver)}),e.$element.on("drop",function(s){e.$element.parent().removeClass(e.opts.classes.loaded).addClass(e.opts.classes.loading),e.$element.parent().removeClass(t.dragOver).addClass(t.dragDrop),s.originalEvent.dataTransfer&&s.originalEvent.dataTransfer.files.length&&(s.preventDefault(),s.stopPropagation(),e.upload.ajax(e,s.originalEvent.dataTransfer.files[0]))})}}},upload:function(){return{ajax:function(e,t){var s=e.core.action(),r=new FormData;r.append("data[File][file]",t),r.append("data[File][fileType]",e.filetype),r.append("data[File][thumbs]",e.thumbs);var o=new XMLHttpRequest;o.upload.addEventListener("progress",function(t){if(t.lengthComputable){var s=Math.round(100*t.loaded/t.total);e.build.progressBarPercent(s)}},!1),o.upload.addEventListener("error",function(){e.upload.error(e)},!1),o.upload.addEventListener("abort",function(){e.upload.error(e)},!1),o.open("post",s,!0),o.onreadystatechange=function(){4==o.readyState&&200==o.status&&e.upload.success(o.responseText)},o.send(r)},jqueryForm:function(e){this.build.form(),this.$form.ajaxForm({beforeSend:function(){e.build.progressBarPercent(0)},uploadProgress:function(t,s,r,o){e.build.progressBarPercent(o)},success:function(){e.build.progressBarPercent(100)},error:function(){e.upload.error(e)},complete:function(t){e.upload.success(t.responseText)}}),this.$form.submit(),this.build.destroyForm()},success:function(t){this.response=e.parseJSON(t),this.element={$element:this.$element,$messageerror:this.$messageerror,$progressbar:this.$progressbar,build:{progressBarPercent:this.build.progressBarPercent},opts:{classes:{dragDrop:this.opts.classes.dragDrop}}},this.opts.success(this.response,this.upload.error,this.element),this.$element.parent().removeClass(this.opts.classes.dragDrop),this.$element.parent().removeClass(this.opts.classes.loading).addClass(this.opts.classes.loaded)},error:function(e,t){e.$progressbar.html("Error"),setTimeout(function(){e.build.progressBarPercent(0),e.$element.parent().removeClass(e.opts.classes.dragDrop),e.$element.parent().removeClass(e.opts.classes.loading).removeClass(e.opts.classes.loaded)},3e3),t?e.$messageerror.html(t).delay(1e3).fadeIn():e.$messageerror.delay(1e3).fadeIn()}}},core:function(){return{isDraggable:function(){return window.FormData&&window.File?!0:!1},action:function(){return window.location.origin+"/"+this.opts.urlUploadFile}}}},t.prototype.init.prototype=t.prototype}(jQuery);