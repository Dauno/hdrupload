!function(e){"use strict";function t(e,r){return new t.prototype.init(e,r)}Function.prototype.bind||(Function.prototype.bind=function(e){var t=this;return function(){return t.apply(e)}});e.fn.hdrupload=function(r){var s=[],i=Array.prototype.slice.call(arguments,1);return this.each("string"==typeof r?function(){var t,o=e.data(this,"hdrupload");if("-1"!=r.search(/\./)?(t=r.split("."),"undefined"!=typeof o[t[0]]&&(t=o[t[0]][t[1]])):t=o[r],"undefined"!=typeof o&&e.isFunction(t)){var n=t.apply(o,i);void 0!==n&&n!==o&&s.push(n)}else e.error('No such method "'+r+'" for hdrupload')}:function(){e.data(this,"hdrupload",{}),e.data(this,"hdrupload",t(this,r))}),0===s.length?this:1===s.length?s[0]:s},e.HDRUpload=t,e.HDRUpload.VERSION="0.0.1",e.HDRUpload.modules=["build","core","upload"],e.HDRUpload.opts={messageError:"",urlUploadFile:"",progressBar:"",thumbs:!1,classes:{dragOver:"",dragDrop:""},success:function(){}},t.fn=e.HDRUpload.prototype={init:function(t,r){this.$element=e(t),this.uuid=Math.floor(1e6*Math.random()),this.inputName=this.$element.children("input[type=file]").attr("name"),this.loadOptions(r),this.loadModules(),this.start=!0,this.build.run()},loadOptions:function(t){this.opts=e.extend({},e.extend(!0,{},e.HDRUpload.opts),this.$element.data(),t)},getModuleMethods:function(e){return Object.getOwnPropertyNames(e).filter(function(t){return"function"==typeof e[t]})},loadModules:function(){for(var t=e.HDRUpload.modules.length,r=0;t>r;r++)this.bindModuleMethods(e.HDRUpload.modules[r])},bindModuleMethods:function(e){if("undefined"!=typeof this[e]){this[e]=this[e]();for(var t=this.getModuleMethods(this[e]),r=t.length,s=0;r>s;s++)this[e][t[s]]=this[e][t[s]].bind(this)}},build:function(){return{run:function(){this.filetype=this.opts.filetype,this.thumbs=this.opts.thumbs,this.$messageerror=this.build.messageError(),this.$progressbar=this.build.progressBar(),this.$messagedroparea=this.build.messageDropArea(),this.core.isDraggable()?this.build.drag(this,this.opts.classes):this.$messagedroparea.remove(),this.build.changeForm(this)},form:function(){this.$form=this.build.createForm(),this.$inputTypeFile=this.build.createInput(),this.$inputThumbs=this.build.createInputThumbs(),this.$element.children("input[type=file]").attr("name","data[File][file]"),this.kids=this.$element.children(),this.$form.append(this.$inputTypeFile),this.$form.append(this.$inputThumbs),this.$form.append(this.kids),this.$element.append(this.$form)},createForm:function(){return e("<form></form>").attr({id:"form-"+this.uuid,method:"post",action:this.core.action(),enctype:"multipart/form-data"})},destroyForm:function(){this.$inputTypeFile.remove(),this.$form.children("input[type=file]").attr("name",this.inputName),this.kids=this.$form.children(),this.$element.append(this.kids),this.$form.remove()},messageError:function(){return e(this.opts.messageError).hide()},messageDropArea:function(){return e(this.opts.messageDropArea)},createInput:function(){return e("<input>").attr({type:"hidden",id:"fileType"+this.uuid,value:this.filetype,name:"data[File][fileType]"})},createInputThumbs:function(){return e("<input>").attr({type:"hidden",id:"thumbs"+this.uuid,value:this.thumbs,name:"data[File][thumbs]"})},progressBar:function(){return e(this.opts.progressBar)},changeForm:function(e){e.$element.on("change","input",function(){e.upload.jqueryForm(e)})},progressBarPercent:function(e){this.percentVal=e+"%",this.$progressbar.css("width",this.percentVal),this.$progressbar.attr("aria-valuenow",e),this.$progressbar.html(this.percentVal)},drag:function(e,t){e.$element.on("dragover",function(r){r.preventDefault(),r.stopPropagation(),e.$element.addClass(t.dragOver)}),e.$element.on("dragenter",function(e){e.preventDefault(),e.stopPropagation()}),e.$element.on("dragleave",function(r){r.preventDefault(),r.stopPropagation(),e.$element.removeClass(t.dragOver)}),e.$element.on("drop",function(r){e.$element.removeClass(t.dragOver).addClass(t.dragDrop),r.originalEvent.dataTransfer&&r.originalEvent.dataTransfer.files.length&&(r.preventDefault(),r.stopPropagation(),e.upload.ajax(e,r.originalEvent.dataTransfer.files[0]))})}}},upload:function(){return{ajax:function(e,t){var r=e.core.action(),s=new FormData;s.append("data[File][file]",t),s.append("data[File][fileType]",e.filetype),s.append("data[File][thumbs]",e.thumbs);var i=new XMLHttpRequest;i.upload.addEventListener("progress",function(t){if(t.lengthComputable){var r=Math.round(100*t.loaded/t.total);e.build.progressBarPercent(r)}},!1),i.upload.addEventListener("error",function(){e.upload.error(e)},!1),i.upload.addEventListener("abort",function(){e.upload.error(e)},!1),i.open("post",r,!0),i.onreadystatechange=function(){4==i.readyState&&200==i.status&&e.upload.success(i.responseText)},i.send(s)},jqueryForm:function(e){this.build.form(),this.$form.ajaxForm({beforeSend:function(){e.build.progressBarPercent(0)},uploadProgress:function(t,r,s,i){e.build.progressBarPercent(i)},success:function(){e.build.progressBarPercent(100)},error:function(){e.upload.error(e)},complete:function(t){e.upload.success(t.responseText)}}),this.$form.submit(),this.build.destroyForm()},success:function(t){this.response=e.parseJSON(t),this.element={$element:this.$element,$messageerror:this.$messageerror,$progressbar:this.$progressbar,build:{progressBarPercent:this.build.progressBarPercent},opts:{classes:{dragDrop:this.opts.classes.dragDrop}}},this.opts.success(this.response,this.upload.error,this.element),this.$element.removeClass(this.opts.classes.dragDrop)},error:function(e,t){e.$progressbar.html("Error"),setTimeout(function(){e.build.progressBarPercent(0),e.$element.removeClass(e.opts.classes.dragDrop)},3e3),t?e.$messageerror.html(t).delay(1e3).fadeIn():e.$messageerror.delay(1e3).fadeIn()}}},core:function(){return{isDraggable:function(){return window.FormData&&window.File?!0:!1},action:function(){return window.location.origin+"/"+this.opts.urlUploadFile}}}},t.prototype.init.prototype=t.prototype}(jQuery);